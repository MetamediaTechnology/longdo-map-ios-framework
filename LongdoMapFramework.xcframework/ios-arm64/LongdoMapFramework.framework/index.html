<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title></title>
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0; font: 12px/1.2 sans-serif; }
      #map { width: 100%; height: 100%; }
    </style>
    <script src="https://${Const.server}?key=${Const.apiKey}"></script>
    <script>
      let objectList = [];
      function init() {
        const placeholder = document.getElementById('map');
        if (!window.longdo) {
          placeholder.innerHTML = navigator.onLine
                       ? '<h4>UNREGISTERED APP</h4><strong>ID</strong>: ${Const.bundleId}'
                       : 'Not connected to network';
          return;
        }
        console.log = (message) => window.webkit.messageHandlers.log.postMessage({"log": JSON.stringify([message])})
        onerror = (message, source, lineno, colno) => {
          console.log(message + ' @ ' + source + '#L' + lineno + ':' + colno);
          return true;
        };
        const props = ${Const.props};
        
        const map = new longdo.Map({
          layer: parse(props.layer),
          zoom: props.zoom,
          zoomRange: props.zoomRange,
          location: props.location,
          ui: props.ui,
          lastView: props.lastView,
          language: props.language,
          placeholder: placeholder
        });
        map.Ui.Geolocation?.visible(false);
        if (props.ready) {
          try {
            const result = serialize(
              map.Event.bind(
                "ready",
                data => window.webkit.messageHandlers.event.postMessage({
                  "id": props.ready,
                  "data": JSON.stringify([serialize(data)])
                })
              )
            );
          } catch (e) {
            console.log(e);
          }
        }
        document.getElementsByClassName('mapboxgl-ctrl-top-left')[0].style.top = 'env(safe-area-inset-top)';
        document.getElementsByClassName('mapboxgl-ctrl-top-left')[0].style.left = 'env(safe-area-inset-left)';
        document.getElementsByClassName('mapboxgl-ctrl-top-right')[0].style.top = 'env(safe-area-inset-top)';
        document.getElementsByClassName('mapboxgl-ctrl-top-right')[0].style.right = 'env(safe-area-inset-right)';
        document.getElementsByClassName('mapboxgl-ctrl-bottom-left')[0].style.bottom = 'env(safe-area-inset-bottom)';
        document.getElementsByClassName('mapboxgl-ctrl-bottom-left')[0].style.left = 'env(safe-area-inset-left)';
        document.getElementsByClassName('mapboxgl-ctrl-bottom-right')[0].style.bottom = 'env(safe-area-inset-bottom)';
        document.getElementsByClassName('mapboxgl-ctrl-bottom-right')[0].style.right = 'env(safe-area-inset-right)';
        map.toJSON = map.Overlays.toJSON = map.Ui.toJSON = () => ({});
        objectList[0] = map;
      }
      function parse(data) {
        if (!data) return data;
        if (data.$static) {
          let value = longdo[data.$static][data.name];
          if (!value) {
            console.log('warning: ' + data.$static + '.' + data.name + ' is undefined.');
          }
          return value;
        }
        if (data.$object) {
          let object = objectList[data.$id];
          if (!object) {
            let dot = data.$object.indexOf('.');
            if (dot < 0) {
              object = new longdo[data.$object](...data.args.map(parse));
            } else {
              object = new longdo[data.$object.substring(0, dot)][data.$object.substring(dot + 1)](...data.args.map(parse));
            }
            object.$id = data.$id;
            objectList[data.$id] = object;
          }
          return object;
        }
        if (data.$function) return eval(data.$function);
        if (Array.isArray(data)) {
          return data.map(parse);
        }
        if (typeof(data) === 'object') {
          let object = {};
          for (i in data) {
            if (i == 'change') {
              const id = data[i];
              object[i] = (from, to) => window.webkit.messageHandlers.change.postMessage({
                "from": JSON.stringify(serialize(from)),
                "to": JSON.stringify(serialize(to)),
                "id": id
              });
            }
            else {
              object[i] = parse(data[i]);
            }
          }
          return object;
        }
        return data;
      }
      function serialize(object) {
        if (!object) return object;
        if (object.$id) return { $object: true, $id: object.$id };
        if (object.active) return { $object: null };
        if (Array.isArray(object)) {
          for (let i = 0; i < object.length; ++i) {
            object[i] = serialize(object[i]);
          }
        }
        return object;
      }
      function call(id, method, args) {
        const dot = method.indexOf('.');
        if (dot < 0) {
          commit(objectList[0], method, args, id);
        } else if (method == 'Tags.add' && (!args || args.length == 0)) {
          try {
            const result = serialize(
              objectList[0].Tags.add(
                (tile, zoom) => window.webkit.messageHandlers.tag.postMessage({
                  "tile": JSON.stringify(tile),
                  "zoom": zoom,
                  "id": id
                })
              )
            );
            window.webkit.messageHandlers.commit.postMessage({
              "result": JSON.stringify([result]) || null,
              "id": id
            });
          } catch (e) {
            window.webkit.messageHandlers.commit.postMessage({
              "result": null,
              "id": id
            });
            console.log(e);
          }
        } else if (method == 'Event.bind' && args.length > 0) {
          try {
            const result = serialize(
              objectList[0].Event.bind(
                args[0],
                data => window.webkit.messageHandlers.event.postMessage({
                  "id": id,
                  "data": JSON.stringify([serialize(data)])
                })
              )
            );
            window.webkit.messageHandlers.commit.postMessage({
              "result": JSON.stringify([result]) || null,
              "id": id
            });
          } catch (e) {
            window.webkit.messageHandlers.commit.postMessage({
              "result": null,
              "id": id
            });
            console.log(e);
          }
        } else {
          const secondDot = method.substring(dot + 1).indexOf('.');
          if (secondDot < 0) {
            commit(objectList[0][method.substring(0, dot)], method.substring(dot + 1), args, id);
          }
          else {
            const subMethod = method.substring(dot + 1);
            commit(objectList[0][method.substring(0, dot)][subMethod.substring(0, secondDot)], subMethod.substring(secondDot + 1), args, id);
          }
        }
      }
      function objectCall(id, object, method, args) {
        commit(parse(object), method, args, id);
      }
      function commit(executor, method, args, id) {
        if (executor && executor[method]) {
          try {
            const result = serialize(executor[method](...args.map(parse)));
            window.webkit.messageHandlers.commit.postMessage({
              "result": JSON.stringify([result]) || null,
              "id": id
            });
          }
          catch (e) {
            window.webkit.messageHandlers.commit.postMessage({
              "result": null,
              "id": id
            });
            console.log(e);
          }
        } else {
          window.webkit.messageHandlers.commit.postMessage({
            "result": null,
            "id": id
          });
          console.log('Method ' + method + ' not found.');
        }
      }
    </script>
  </head>
  <body onload="init();">
    <div id="map"></div>
  </body>
</html>
